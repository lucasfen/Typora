## 基本概念

![image-20220409102732358](C:\Users\fqh0722\AppData\Roaming\Typora\typora-user-images\image-20220409102732358.png)

![image-20220409102841269](C:\Users\fqh0722\AppData\Roaming\Typora\typora-user-images\image-20220409102841269.png)

## 重要概念

**ISR集合**：副本同步集合，与leader副本保持同步状态的副本集合，当ISR集合中的一个follower副本之后leader副本的时间超过设定的参数时，则判定为同步失败，此follower副本就会被剔除出ISR集合

**LEO:**每一个分区中最后一条消息的下一个位置,分区的每一个副本都有自己的LEO

**HW:**ISR中最小的LEO,消费者只能拉取到HW之前的消息

## 使用消息队列的好处

1. 解耦：允许独立扩展或修改两边的处理过程
2. 削峰：使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而崩溃
3. 可恢复性：一个处理消息的进程挂掉，加入队列中的消息仍然可以在系统恢复后被处理
4. 缓冲：有助于控制和优化数据流经过系统的速度，解决生产消息和消费消息的处理速度不一致的情况。
5. 异步通信：提供了异步处理机制， 允许用户把一个消息放入队列，但不立即处理，在需要时再去处理。

## 分区副本选主机制

从AR集合中选择第一个副本作为分区leader，且这个副本在ISR集合中

## 消费者分区分配策略

1~9号分区，分给A,B,C三个消费者

- 平均分配，1~3号给A， 4~6号给B，7~9号给C
- 轮询分配， 1，4，7号给A， 2，5，8号给B， 3，6，9号给C
- 粘性分配，初始分配时与轮询分配类似， 但重分配时，要满足：1.分配尽可能均与。2.尽可能与上次分配保持相同

## 生产者消息路由策略

1. 指定了 patition，则直接使用； 
2. 未指定 patition 但指定 key，通过对 key 的 value 进行hash 选出一个 patition 
3. patition 和 key 都未指定，使用轮询选出一个 patition

## 消息确认机制

- ack=1(默认值)， 只要leader节点收到消息，不用等所有副本同步，生产者就会收到一条确认消息
- ack=0,生产者不用等leader节点的确认消息，直接发送下一条消息
- ack=-1或者all, 需要等到所有副本完成同步，生产者才会收到一条确认消息

## kafka文件存储

找offset=3的message:

1. 遍历索引文件，找到包含offset=3的索引文件，确定其所在的segment
2. 在索引文件中查找offset=3的记录
3. 如果在索引文件中查找到的offset=3的记录，则根据索引文件提供的物理地址，直接在log文件中定位到offset=3的消息
4. 如果在索引文件中没有找到offset=3的记录，则需要根据最近的offset的物理地址，顺序查找到offset=3的message

## Kafka高性能原因

- 磁盘顺序读写。kafka消息不能修改，不会从文件中间删除，保证了磁盘顺序读， kafka消息写入文件都是追加在文件末尾，不会写入文件中的某个位置，保证了磁盘顺序写
- 数据传输零拷贝
- 页缓存。操作系统本身有一层缓存，是在内存里。kafka在写入磁盘文件的时候，可以直接写入这个缓存中，接下来由操作系统决定什么时候吧缓存里的数据刷入磁盘文件中
- kafka允许批量发送消息

## kafka消息重复消费

可能的原因：1.配置了重试机制。2.消费者消费消息后没有提交offset

解决方案：1.消费端做消费幂等处理，即给每一条消息加上一个唯一标识，如果消费到相同的标识，则不做处理。2.生产者端做幂等处理，在每一条消息加上pid和消息序列号